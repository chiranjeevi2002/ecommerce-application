package com.ecommerce.userservice.controller;

import com.ecommerce.common.security.SecurityConstants;
import com.ecommerce.common.security.UserRoles;
import com.ecommerce.userservice.dto.RoleSummary;
import com.ecommerce.userservice.dto.UserResponse;
import com.ecommerce.userservice.dto.UserRoleUpdateRequest;
import com.ecommerce.userservice.service.admin.UserAdminService;
import jakarta.validation.Valid;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping(SecurityConstants.ADMIN + "/users")
@PreAuthorize("hasAnyAuthority(@userRoles.ADMIN_ACCESS)")
public class AdminUserController {

    private final UserAdminService adminService;

    public AdminUserController(UserAdminService adminService) {
        this.adminService = adminService;
    }

    @GetMapping
    public ResponseEntity<List<UserResponse>> listUsers(
            @RequestParam(required = false) Integer page,
            @RequestParam(required = false) Integer size,
            @RequestParam(required = false) String q,
            @RequestParam(required = false) Long storeId
    ) {
        return ResponseEntity.ok(adminService.listUsers(page, size, q, storeId));
    }

    @GetMapping("/{id}")
    public ResponseEntity<UserResponse> getUser(@PathVariable Long id) {
        return ResponseEntity.ok(adminService.getUser(id));
    }

    @PutMapping("/roles")
    public ResponseEntity<UserResponse> updateRoles(
            @Valid @RequestBody UserRoleUpdateRequest request
    ) {
        return ResponseEntity.ok(adminService.updateUserRoles(request));
    }

    @GetMapping("/roles")
    public ResponseEntity<List<RoleSummary>> getRoles() {
        return ResponseEntity.ok(adminService.listAllRoles());
    }
}
