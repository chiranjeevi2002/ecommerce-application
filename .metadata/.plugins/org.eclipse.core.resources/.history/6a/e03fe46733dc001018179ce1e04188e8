package com.ecommerce.inventoryservice.service.impl;


import java.time.Instant;
import java.util.ArrayList;
import java.util.List;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.ecommerce.inventoryservice.dto.InventoryRollbackRequest;
import com.ecommerce.inventoryservice.dto.InventoryRollbackResponse;
import com.ecommerce.inventoryservice.model.InventoryRollbackLog;
import com.ecommerce.inventoryservice.repository.InventoryRepository;
import com.ecommerce.inventoryservice.repository.InventoryRollbackLogRepository;
import com.ecommerce.inventoryservice.service.InventoryRollbackService;

import jakarta.persistence.EntityNotFoundException;

@Service
public class InventoryRollbackServiceImpl implements InventoryRollbackService {

    private final InventoryRepository inventoryRepository;
    private final InventoryRollbackLogRepository rollbackLogRepository;

    public InventoryRollbackServiceImpl(
            InventoryRepository inventoryRepository,
            InventoryRollbackLogRepository rollbackLogRepository
    ) {
        this.inventoryRepository = inventoryRepository;
        this.rollbackLogRepository = rollbackLogRepository;
    }

    @Override
    @Transactional
    public InventoryRollbackResponse rollback(InventoryRollbackRequest request) {

        rollbackLogRepository
                .findByOrderIdAndStoreId(request.orderId(), request.storeId())
                .ifPresent(log -> {
                    throw new IllegalStateException("Rollback already executed");
                });

        List<Long> restored = new ArrayList<>();
        List<Long> skipped = new ArrayList<>();

        request.items().forEach(item -> {

            var inv = inventoryRepository
                    .findByProductIdAndStoreId(item.productId(), request.storeId())
                    .orElseThrow(() -> new EntityNotFoundException("Inventory not found"));

            inv.setAvailableQuantity(
                    inv.getAvailableQuantity() + item.quantity()
            );

            inventoryRepository.save(inv);
            restored.add(item.productId());
        });

        var log = new InventoryRollbackLog();
        log.setOrderId(request.orderId());
        log.setStoreId(request.storeId());
        rollbackLogRepository.save(log);

        return new InventoryRollbackResponse(
                request.orderId(),
                request.storeId(),
                true,
                restored,
                skipped,
                Instant.now()
        );
    }
}

