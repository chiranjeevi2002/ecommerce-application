package com.ecommerce.orderservice.security;

import com.ecommerce.common.security.AuthHeaderExtractor;
import com.ecommerce.common.security.SecurityHeaders;

import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.ReactiveSecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import org.springframework.web.server.WebFilter;
import org.springframework.web.server.WebFilterChain;

import reactor.core.publisher.Mono;

@Component
public class GatewayHeaderAuthenticationWebFilter implements WebFilter {

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, WebFilterChain chain) {

        return ReactiveSecurityContextHolder.getContext()
                .map(ctx -> ctx.getAuthentication())
                .defaultIfEmpty(null)
                .flatMap(existingAuth -> {

                    if (existingAuth != null && existingAuth.isAuthenticated()) {
                        return chain.filter(exchange);
                    }

                    ServerHttpRequest request = exchange.getRequest();

                    String username = request.getHeaders().getFirst(SecurityHeaders.USERNAME);
                    String rolesHeader = request.getHeaders().getFirst(SecurityHeaders.ROLES);

                    if (username == null || rolesHeader == null || rolesHeader.isBlank()) {
                        return chain.filter(exchange);
                    }

                    var authorities =
                            AuthHeaderExtractor.extractRoles(rolesHeader)
                                    .stream()
                                    .map(SimpleGrantedAuthority::new)
                                    .toList();

                    if (authorities.isEmpty()) {
                        return chain.filter(exchange);
                    }

                    Authentication authentication =
                            new UsernamePasswordAuthenticationToken(
                                    username,
                                    null,
                                    authorities
                            );

                    return chain.filter(exchange)
                            .contextWrite(
                                    ReactiveSecurityContextHolder.withAuthentication(authentication)
                            );
                });
    }
}
