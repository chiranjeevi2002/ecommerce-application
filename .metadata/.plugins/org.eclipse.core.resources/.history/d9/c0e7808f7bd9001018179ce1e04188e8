package com.ecommerce.apigateway.config;


import java.util.Set;

import org.springframework.cloud.gateway.route.RouteLocator;
import org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import com.ecommerce.apigateway.filter.GatewayAuthorizationFilter;
import com.ecommerce.common.security.ProductRoles;
import com.ecommerce.common.security.SecurityConstants;

import lombok.RequiredArgsConstructor;

@Configuration
@RequiredArgsConstructor
public class GatewayRoutesConfig {

    private final GatewayAuthorizationFilter authz;

    @Bean
    public RouteLocator routes(RouteLocatorBuilder builder) {

        return builder.routes()

            // PRODUCT SERVICE (public read)
            .route("product-service", r -> r
                .path(SecurityConstants.PRODUCTS)
                .uri("lb://PRODUCTSERVICE")
            )

            // ADMIN APIs (coarse check)
            .route("admin-apis", r -> r
                .path(SecurityConstants.ADMIN)
                .filters(f -> f.filter((exchange, chain) ->
                        authz.requireAnyRole(
                                exchange,
                                ProductRoles.WRITE
                        ).then(chain.filter(exchange))
                ))
                .uri("lb://PRODUCTSERVICE")
            )

            // ORDER SERVICE (authenticated users only)
            .route("order-service", r -> r
                .path(SecurityConstants.ORDERS)
                .filters(f -> f.filter((exchange, chain) ->
                        authz.requireAuthenticated(exchange)
                                .then(chain.filter(exchange))
                ))
                .uri("lb://ORDERSERVICE")
            )

            // PAYMENT SERVICE (block GUEST early)
            .route("payment-service", r -> r
                .path(SecurityConstants.PAYMENTS)
                .filters(f -> f.filter((exchange, chain) ->
                        authz.requireAnyRole(
                                exchange,
                                Set.of(
                                        "ROLE_ADMIN",
                                        "ROLE_SUPERADMIN",
                                        "ROLE_FINANCE"
                                )
                        ).then(chain.filter(exchange))
                ))
                .uri("lb://PAYMENTSERVICE")
            )

            .build();
    }
}
