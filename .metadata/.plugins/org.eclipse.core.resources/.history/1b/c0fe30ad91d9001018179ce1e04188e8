package com.ecommerce.userservice.service.admin.impl;

import com.ecommerce.common.security.Role;
import com.ecommerce.userservice.dto.RoleSummary;
import com.ecommerce.userservice.dto.UserResponse;
import com.ecommerce.userservice.model.User;
import com.ecommerce.userservice.repository.RoleRepository;
import com.ecommerce.userservice.repository.UserRepository;
import com.ecommerce.userservice.service.admin.UserAdminService;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

@Service
@Transactional
public class UserAdminServiceImpl implements UserAdminService {

	private final UserRepository userRepository;
	private final RoleRepository roleRepository;

	public UserAdminServiceImpl(UserRepository userRepository, RoleRepository roleRepository) {
		this.userRepository = userRepository;
		this.roleRepository = roleRepository;
	}

	@Override
	public List<UserResponse> listUsers(int page, int size, String q, Long storeId) {
		var pageable = PageRequest.of(Math.max(page, 0), Math.min(size, 100), Sort.by("id").descending());

		return userRepository.search(q, storeId, pageable).stream().map(this::toResponse).collect(Collectors.toList());
	}

	@Override
	public UserResponse getUser(Long userId) {
		return userRepository.findById(userId).map(this::toResponse)
				.orElseThrow(() -> new IllegalArgumentException("User not found"));
	}

	@Override
	public UserResponse updateUserRoles(Long userId, List<String> roles, Long storeId) {
		User user = userRepository.findById(userId).orElseThrow(() -> new IllegalArgumentException("User not found"));

		if (storeId != null && !storeId.equals(user.getStoreId())) {
			throw new IllegalArgumentException("User does not belong to this store");
		}

		Set<String> authorities = roles.stream().map(this::validateRole).collect(Collectors.toSet());

		user.setRoles(authorities.stream().map(this::resolveDbRole).collect(Collectors.toSet()));

		return toResponse(user);
	}

	@Override
	public List<RoleSummary> listAllRoles() {
		return List.of(Role.values()).stream().map(r -> new RoleSummary(r.name(), r.authority()))
				.collect(Collectors.toList());
	}

	private String validateRole(String role) {
		Role.valueOf(role);
		return Role.valueOf(role).authority();
	}

	private com.ecommerce.userservice.model.Role resolveDbRole(String authority) {
		return roleRepository.findByName(authority)
				.orElseGet(() -> roleRepository.save(new com.ecommerce.userservice.model.Role(null, authority)));
	}

	private UserResponse toResponse(User user) {
		return new UserResponse(user.getId(), user.getUsername(), user.getEmail(), user.getStoreId(), user.getRoles()
				.stream().map(com.ecommerce.userservice.model.Role::getName).collect(Collectors.toSet()));
	}
}
