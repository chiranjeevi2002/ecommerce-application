server:
  port: 8080

spring:
  application:
    name: apigateway

#  config:
#    enabled: false
#    import: "optional:configserver:http://localhost:8888"

  cloud:
    gateway:
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials

      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
            allowCredentials: false

      routes:

        # USERSERVICE (AUTH) ##
        - id: userservice-auth-v1
          uri: lb://userservice
          predicates:
            - Path=/api/v1/authservice/auth/**
          filters:
            - StripPrefix=2
            # - RewritePath=/api/v1/userservice/(?<segment>.*), /authservice/${segment}

        # USERSERVICE (SECURED) ##
        - id: userservice-secured-v1
          uri: lb://userservice
          predicates:
            - Path=/api/v1/userservice/users/**
          filters:
            - StripPrefix=2
            - JwtAuthenticationFilter

        # ORDERSERVICE ##
        - id: orderservice-v1
          uri: lb://orderservice
          predicates:
            - Path=/api/v1/orderservice/orders/**
          filters:
            - StripPrefix=2
            - JwtAuthenticationFilter
            - name: CircuitBreaker
              args:
                name: orderserviceCB
                fallbackUri: forward:/gateway-fallback/orderservice
            - name: RequestRateLimiter
              args:
                "[redis-rate-limiter.replenishRate]": 20
                "[redis-rate-limiter.burstCapacity]": 40

        # PRODUCTSERVICE ##
        - id: productservice-v1
          uri: lb://productservice
          predicates:
            - Path=/api/v1/productservice/products/**
          filters:
            - StripPrefix=2
            - JwtAuthenticationFilter

        - id: productservice-uploads
          uri: lb://productservice
          predicates:
            - Path=/uploads/**
          filters:
            - StripPrefix=0


        # INVENTORYSERVICE ##
        - id: inventoryservice-v1
          uri: lb://inventoryservice
          predicates:
            - Path=/api/v1/inventoryservice/inventory/**
          filters:
            - StripPrefix=2
            - JwtAuthenticationFilter

        # PAYMENTSERVICE ##
        - id: paymentservice-v1
          uri: lb://paymentservice
          predicates:
            - Path=/api/v1/paymentservice/payments/**
          filters:
            - StripPrefix=2
            - JwtAuthenticationFilter

        # OPENAPI — Orderservice ##
        - id: orderservice-openapi
          uri: lb://orderservice
          predicates:
            - Path=/v3/api-docs/orderservice/**
          filters:
            - RewritePath=/v3/api-docs/orderservice(?<segment>/.*|), /v3/api-docs${segment}

        # OPENAPI — Productservice ##
        - id: productservice-openapi
          uri: lb://productservice
          predicates:
            - Path=/v3/api-docs/productservice/**
          filters:
            - RewritePath=/v3/api-docs/productservice(?<segment>/.*|), /v3/api-docs${segment}

        # OPENAPI — Userservice ##
        - id: userservice-openapi
          uri: lb://userservice
          predicates:
            - Path=/v3/api-docs/userservice/**
          filters:
            - RewritePath=/v3/api-docs/userservice(?<segment>/.*|), /v3/api-docs${segment}

        # OPENAPI — Inventoryservice ##
        - id: inventoryservice-openapi
          uri: lb://inventoryservice
          predicates:
            - Path=/v3/api-docs/inventoryservice/**
          filters:
            - RewritePath=/v3/api-docs/inventoryservice(?<segment>/.*|), /v3/api-docs${segment}

        # OPENAPI — Paymentservice ##
        - id: paymentservice-openapi
          uri: lb://paymentservice
          predicates:
            - Path=/v3/api-docs/paymentservice/**
          filters:
            - RewritePath=/v3/api-docs/paymentservice(?<segment>/.*|), /v3/api-docs${segment}

jwt:
# Replace this with a real base64 key generated by: openssl rand -base64 32
  secret-base64: "vVkNwgLCuunJto86RZveCtNr/HvBEFkpuT13zUNNjhQ="
  expiration-millis: 3600000
  issuer: ecommerce-backend
  
eureka:
  client:
    enabled: true
    service-url:
      defaultZone: http://localhost:8761/eureka/
  instance:
    prefer-ip-address: true
    # hostname: localhost
    # ip-address: 127.0.0.1
    instance-id: ${spring.application.name}:${server.port}
    # lease-renewal-interval-in-seconds: 2    # heartbeat every 10s
    # lease-expiration-duration-in-seconds: 5

management:
  endpoints:
    web:
      exposure:
        include: "*"

  tracing:
    enabled: true
    sampling:
      probability: 1.0

  zipkin:
    tracing:
      endpoint: http://localhost:9411/api/v2/spans
      enabled: false

springdoc:
  swagger-ui:
    path: /api/v1/docs
    urls:
      - name: Orderservice
        url: /v3/api-docs/orderservice
      - name: Productservice
        url: /v3/api-docs/productservice
      - name: Inventoryservice
        url: /v3/api-docs/inventoryservice
      - name: Paymentservice
        url: /v3/api-docs/paymentservice
      - name: Userservice
        url: /v3/api-docs/userservice
