package com.ecommerce.orderservice.client.impl;

import com.ecommerce.common.security.SecurityConstants;
import com.ecommerce.orderservice.client.InventoryClient;
import com.ecommerce.orderservice.dto.InventoryResponse;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.core.publisher.Mono;

@Component
public class InventoryClientImpl implements InventoryClient {

	private static final String SERVICE_ID = "INVENTORYSERVICE";

	private final WebClient webClient;

	public InventoryClientImpl(WebClient webClient) {
		this.webClient = webClient;
	}

	@Override
	public Mono<InventoryResponse> decrease(Long productId, Integer quantity, Long storeId) {

		return webClient.post()
				.uri("http://" + SERVICE_ID + SecurityConstants.INVENTORY_BASE + "/decrease/{productId}?qty={qty}",
						productId, quantity)
				.header("X-Store-Id", String.valueOf(storeId)).retrieve()
				.onStatus(status -> status.is4xxClientError(),
						response -> Mono.error(new IllegalStateException("Insufficient inventory")))
				.onStatus(status -> status.is5xxServerError(),
						response -> Mono.error(new IllegalStateException("Inventory service unavailable")))
				.bodyToMono(InventoryResponse.class);
	}

	@Override
	public Mono<InventoryResponse> increase(Long productId, Integer quantity, Long storeId) {

		return webClient.post()
				.uri("http://" + SERVICE_ID + SecurityConstants.INVENTORY_BASE + "/increase/{productId}?qty={qty}",
						productId, quantity)
				.header("X-Store-Id", String.valueOf(storeId)).retrieve()
				.onStatus(status -> status.is4xxClientError(),
						response -> Mono.error(new IllegalStateException("Inventory rollback failed")))
				.onStatus(status -> status.is5xxServerError(),
						response -> Mono.error(new IllegalStateException("Inventory service unavailable")))
				.bodyToMono(InventoryResponse.class);
	}
}
