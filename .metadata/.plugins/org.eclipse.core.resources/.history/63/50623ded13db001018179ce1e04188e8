package com.ecommerce.productservice.service.impl;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.StandardCopyOption;
import java.util.List;
import java.util.UUID;
import java.util.function.Function;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import com.ecommerce.productservice.service.FileStorageService;

@Service
public class FileStorageServiceImpl implements FileStorageService {

    private static final Logger log = LoggerFactory.getLogger(FileStorageServiceImpl.class);

    // Local relative path inside productservice (e.g. productservice/uploads)
    private final Path rootLocation = Path.of("uploads");

    @Override
    public List<String> uploadFiles(List<MultipartFile> files, Long storeId) {
        if (files == null || files.isEmpty()) {
            throw new IllegalArgumentException("No files provided");
        }

        var storeFolder = rootLocation.resolve("store-" + storeId);
        createDirectoryIfNotExists(storeFolder);

        // mapper for storing a single file
        Function<MultipartFile, String> storeFile = file -> {
            var ext = getExtension(file.getOriginalFilename());
            var filename = UUID.randomUUID() + (ext.isEmpty() ? "" : "." + ext);
            var target = storeFolder.resolve(filename);

            try (var inputStream = file.getInputStream()) {
                Files.copy(inputStream, target, StandardCopyOption.REPLACE_EXISTING);
                log.info("Stored file: {}", target.toAbsolutePath());
            } catch (IOException e) {
                log.error("File save failed: {}", file.getOriginalFilename(), e);
                throw new RuntimeException("File upload failed");
            }

            // Returned URL served through API Gateway: /uploads/store-<id>/file.jpg
            return "/uploads/store-" + storeId + "/" + filename;
        };

        return files.stream()
                .filter(f -> !f.isEmpty())
                .map(storeFile)
                .toList();
    }

    @Override
    public void deleteFile(String fileUrl) {
        if (fileUrl == null || fileUrl.isBlank()) {
            return;
        }
        try {
            // Remove leading "/uploads/"
            var cleaned = fileUrl.replaceFirst("^/uploads/", "");
            var filePath = rootLocation.resolve(cleaned);

            Files.deleteIfExists(filePath);
            log.info("Deleted file: {}", filePath.toAbsolutePath());
        } catch (Exception e) {
            log.warn("Error deleting file {}", fileUrl, e);
        }
    }

    private void createDirectoryIfNotExists(Path dir) {
        try {
            if (Files.notExists(dir)) {
                Files.createDirectories(dir);
            }
        } catch (IOException e) {
            log.error("Failed to create upload directory {}", dir, e);
            throw new RuntimeException("Failed to create upload directory");
        }
    }

    private String getExtension(String filename) {
        if (filename == null || filename.isBlank()) return "";
        var index = filename.lastIndexOf('.');
        return index < 0 ? "" : filename.substring(index + 1);
    }
}
