server:
  port: 8080

spring:
  application:
    name: apigateway

  cloud:
    gateway:
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials

      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins:
              - http://localhost:5173
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders:
              - Authorization
              - Content-Type
              - X-User-Id
              - X-User-Name
              - X-User-Roles
              - X-Store-Id
            allowCredentials: true

      routes:
        # Public auth APIs
        - id: userservice-auth
          uri: lb://USERSERVICE
          predicates:
            - Path=/api/v1/auth/**

        # Secured user APIs
        - id: userservice-secured
          uri: lb://USERSERVICE
          predicates:
            - Path=/api/v1/users/**

        - id: productservice
          uri: lb://PRODUCTSERVICE
          predicates:
            - Path=/api/v1/products/**,/api/v1/admin/**

        # Static uploads (images, etc.)
        - id: productservice-uploads
          uri: lb://PRODUCTSERVICE
          predicates:
            - Path=/uploads/**

        - id: orderservice
          uri: lb://ORDERSERVICE
          predicates:
            - Path=/api/v1/orders/**
          filters:
            - name: CircuitBreaker
              args:
                name: orderserviceCB
                fallbackUri: forward:/gateway-fallback
            # Rate limiter can be enabled later
            # - name: RequestRateLimiter
            #   args:
            #     redis-rate-limiter.replenishRate: 20
            #     redis-rate-limiter.burstCapacity: 40

        - id: inventoryservice
          uri: lb://INVENTORYSERVICE
          predicates:
            - Path=/api/v1/inventory/**

        - id: paymentservice
          uri: lb://PAYMENTSERVICE
          predicates:
            - Path=/api/v1/payments/**

        # ========= OPENAPI / SWAGGER AGGREGATION =========

        - id: userservice-openapi
          uri: lb://USERSERVICE
          predicates:
            - Path=/v3/api-docs/userservice/**
          filters:
            - RewritePath=/v3/api-docs/userservice(?<segment>/.*|), /v3/api-docs${segment}

        - id: productservice-openapi
          uri: lb://PRODUCTSERVICE
          predicates:
            - Path=/v3/api-docs/productservice/**
          filters:
            - RewritePath=/v3/api-docs/productservice(?<segment>/.*|), /v3/api-docs${segment}

        - id: orderservice-openapi
          uri: lb://ORDERSERVICE
          predicates:
            - Path=/v3/api-docs/orderservice/**
          filters:
            - RewritePath=/v3/api-docs/orderservice(?<segment>/.*|), /v3/api-docs${segment}

        - id: inventoryservice-openapi
          uri: lb://INVENTORYSERVICE
          predicates:
            - Path=/v3/api-docs/inventoryservice/**
          filters:
            - RewritePath=/v3/api-docs/inventoryservice(?<segment>/.*|), /v3/api-docs${segment}

        - id: paymentservice-openapi
          uri: lb://PAYMENTSERVICE
          predicates:
            - Path=/v3/api-docs/paymentservice/**
          filters:
            - RewritePath=/v3/api-docs/paymentservice(?<segment>/.*|), /v3/api-docs${segment}

# JWT (validated at Gateway only)
jwt:
  secret-base64: "vVkNwgLCuunJto86RZveCtNr/HvBEFkpuT13zUNNjhQ="
  expiration-millis: 3600000
  issuer: ecommerce-backend

eureka:
  client:
    enabled: true
    service-url:
      defaultZone: http://localhost:8761/eureka/
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${server.port}

# Actuator / Observability
management:
  endpoints:
    web:
      exposure:
        include: "*"

# Swagger UI (Gateway Aggregator)
springdoc:
  swagger-ui:
    path: /api/v1/docs
