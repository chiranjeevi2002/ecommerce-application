package com.ecommerce.common.webflux.webclient;

import java.time.Duration;

import org.springframework.web.reactive.function.client.ClientRequest;
import org.springframework.web.reactive.function.client.ClientResponse;
import org.springframework.web.reactive.function.client.ExchangeFilterFunction;

import io.micrometer.core.instrument.MeterRegistry;
import io.micrometer.core.instrument.Timer;
import reactor.core.publisher.Mono;

public final class WebClientMetricsFilter {

	private final MeterRegistry meterRegistry;

	public WebClientMetricsFilter(MeterRegistry meterRegistry) {
		this.meterRegistry = meterRegistry;
	}

	public ExchangeFilterFunction filter() {

		return (request, next) -> {

			long startTime = System.nanoTime();

			Mono<ClientResponse> exchangeMono = next.exchange(request);

			return exchangeMono.doOnSuccess(response -> recordSuccess(request, response, startTime))
					.doOnError(error -> recordFailure(request, startTime));
		};
	}

	private void recordSuccess(ClientRequest request, ClientResponse response, long startTime) {

		Timer.builder("http.client.requests").tag("method", request.method().name()).tag("uri", normalizeUri(request))
				.tag("status", String.valueOf(response.statusCode().value()))
				.tag("service", extractServiceName(request)).register(meterRegistry)
				.record(Duration.ofNanos(System.nanoTime() - startTime));
	}

	private void recordFailure(ClientRequest request, long startTime) {

		Timer.builder("http.client.requests").tag("method", request.method().name()).tag("uri", normalizeUri(request))
				.tag("status", "ERROR").tag("service", extractServiceName(request)).register(meterRegistry)
				.record(Duration.ofNanos(System.nanoTime() - startTime));
	}

	private String normalizeUri(ClientRequest request) {
		return request.url().getPath();
	}

	private String extractServiceName(ClientRequest request) {

		String host = request.url().getHost();
		return host != null ? host : "unknown";
	}
}
