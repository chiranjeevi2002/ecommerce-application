package com.ecommerce.orderservice.service.workflow;


import java.util.ArrayList;
import java.util.List;

import reactor.core.publisher.Mono;

public class WorkflowExecutor {

    private final List<WorkflowDefinition> steps = new ArrayList<>();

    public WorkflowExecutor addStep(WorkflowDefinition definition) {
        steps.add(definition);
        return this;
    }

    public Mono<WorkflowContext> execute(WorkflowContext context) {

        List<WorkflowDefinition> completed = new ArrayList<>();

        Mono<WorkflowContext> flow = Mono.just(context);

        for (WorkflowDefinition def : steps) {
            flow = flow.flatMap(ctx ->
                    def.step().execute(ctx)
                            .doOnSuccess(c -> completed.add(def))
            );
        }

        return flow.onErrorResume(ex ->
                rollback(completed, context)
                        .then(Mono.error(ex))
        );
    }

    private Mono<Void> rollback(
            List<WorkflowDefinition> completed,
            WorkflowContext context
    ) {
        return Flux.fromIterable(completed)
                .reverse()
                .flatMap(def -> def.compensation().compensate(context))
                .then();
    }

}
