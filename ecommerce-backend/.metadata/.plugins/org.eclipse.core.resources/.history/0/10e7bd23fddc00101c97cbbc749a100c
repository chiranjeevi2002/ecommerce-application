package com.ecommerce.common.webflux.webclient;

import com.ecommerce.common.webflux.context.ReactiveContextHolder;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.client.WebClient;

@Configuration
public class WebClientFactory {

    @Bean
    public WebClient webClient(WebClient.Builder builder) {
        return builder
                .filter((request, next) ->
                        ReactiveContextHolder.get()
                                .flatMap(ctx -> next.exchange(
                                        ClientRequest.from(request)
                                                .header("X-User-Id", String.valueOf(ctx.userId()))
                                                .header("X-Store-Id", String.valueOf(ctx.storeId()))
                                                .header("X-User-Name", ctx.username())
                                                .build()
                                ))
                )
                .build();
    }
}
