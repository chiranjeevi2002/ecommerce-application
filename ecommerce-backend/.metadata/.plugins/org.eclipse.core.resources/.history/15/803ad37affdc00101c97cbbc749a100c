package com.ecommerce.orderservice.filter;

import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import org.springframework.web.server.WebFilter;
import org.springframework.web.server.WebFilterChain;

import com.ecommerce.common.context.RequestContext;
import com.ecommerce.common.context.RequestContextMapper;
import com.ecommerce.common.context.RequestHeaders;
import com.ecommerce.orderservice.context.ReactiveRequestContextHolder;

import reactor.core.publisher.Mono;

@Component
@Order(Ordered.HIGHEST_PRECEDENCE)
public class RequestContextWebFilter implements WebFilter {

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, WebFilterChain chain) {

        var headers = exchange.getRequest().getHeaders();

        RequestContext context = RequestContextMapper.fromHeaders(
                headers.getFirst(RequestHeaders.USER_ID),
                headers.getFirst(RequestHeaders.STORE_ID),
                headers.getFirst(RequestHeaders.USERNAME),
                headers.getFirst(RequestHeaders.ROLES),
                headers.getFirst(RequestHeaders.AUTHORIZATION)
        );

        return chain.filter(exchange)
                .contextWrite(ReactiveRequestContextHolder.with(context));
    }
}
